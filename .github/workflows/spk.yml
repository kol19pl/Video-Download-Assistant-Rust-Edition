name: SPK Build and Release

on:
  workflow_run:
    workflows: ["Rust Multi-Platform Release"]
    types:
      - completed
  workflow_dispatch: {}

jobs:
  build-spk:
    name: Build SPK Package
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download latest yt-dlp (zipapp)
        shell: bash
        run: |
          echo "Downloading latest yt-dlp..."
          mkdir -p SPK_AP_TEMPLATE/pakiet/bin

          curl -L \
            https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp \
            -o SPK_AP_TEMPLATE/pakiet/bin/yt-dlp

          chmod +x SPK_AP_TEMPLATE/pakiet/bin/yt-dlp
          SPK_AP_TEMPLATE/pakiet/bin/yt-dlp --version

      - name: Update SPK version with build date
        run: |
          # Get current date in YYYY.MM.DD format
          BUILD_DATE=$(date +%Y.%m.%d)
          # Update version in INFO file
          sed -i 's/^version=".*"/version="'${BUILD_DATE}'"/' SPK_AP_TEMPLATE/INFO
          echo "Updated SPK version to: ${BUILD_DATE}"

      - name: Make scripts executable
        run: |
          # Make all files in scripts directory executable
          chmod +x SPK_AP_TEMPLATE/scripts/*
          echo "Made all scripts in SPK_AP_TEMPLATE/scripts executable"

      - name: Download binary for SPK
        run: |
          # Download the x86_64-unknown-linux-musl binary from the latest release
          mkdir -p release/_temp _build/Spk _build/package

          # Get the latest release tag
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)

          # Download the binary
          curl -L \
            https://github.com/${{ github.repository }}/releases/download/${LATEST_TAG}/vda_server-x86_64-unknown-linux-musl \
            -o SPK_AP_TEMPLATE/pakiet/vda_server-x86_64-unknown-linux-musl

          chmod +x SPK_AP_TEMPLATE/pakiet/vda_server-x86_64-unknown-linux-musl
          echo "Downloaded binary for SPK package"

      - name: Build SPK package
        run: |
          packageName=$(grep '^package=' "SPK_AP_TEMPLATE/INFO" | cut -d'=' -f2 | tr -d '" ')
          rsync -av --exclude='pakiet' SPK_AP_TEMPLATE/ _build/Spk/
          rsync -ah SPK_AP_TEMPLATE/pakiet/ _build/package/
          cd _build/package
          tar czf ../Spk/package.tgz *
          cd ../Spk
          tar cf ../../release/_temp/${packageName}.spk *
          echo "SPK_OUT=release/_temp/${packageName}.spk" >> $GITHUB_ENV

      - name: Get the tag from the triggering workflow
        id: get_tag
        run: |
          # Get the latest release that was created by the Rust Multi-Platform Release workflow
          # We assume that the latest release is the one we want to add the SPK to
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          echo "TAG_NAME=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $LATEST_TAG"

      - name: Upload SPK to Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.SPK_OUT }}
          tag_name: ${{ steps.get_tag.outputs.TAG_NAME }}
          append_body: true
